
<input name="attr_designing_spell" type="hidden" value="0"/>
<div class="sheet-blocking-modal">
  <div class="sheet-group sheet-modal">
    <h2>designing spells</h2>
    <input name="attr_spell_step" type="hidden" value="1"/>
    <input name="attr_spell_cost" type="hidden" value="0"/>
    <input name="attr_spell_area_of_effect" type="hidden" value="0"/>
    <input name="attr_spell_effect" type="hidden" value="0"/>
    <div class="sheet-steps">
      <div class="sheet-step-1">
        <h3>spell name</h3>
        <input class="sheet-align-left" name="attr_spell_name" type="text" value="My Spell"/>
      </div>
      <div class="sheet-step-2">
        <h3>invocation time</h3>
        <div class="sheet-options">
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_invocation_time" type="radio" value="30 minutes,1" checked="checked"/>30 minutes
            </label><span class="cost">1 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_invocation_time" type="radio" value="20 minutes,2"/>20 minutes
            </label><span class="cost">2 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_invocation_time" type="radio" value="10 minutes,3"/>10 minutes
            </label><span class="cost">3 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_invocation_time" type="radio" value="1 minute,4"/>1 minute
            </label><span class="cost">4 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_invocation_time" type="radio" value="instant,5"/>instant
            </label><span class="cost">5 point(s)</span>
          </div>
        </div>
        <p>The longer a sorcerer or mystic takes to invoke a spell, the easier it becomes to cast it correctly (therefore, the lower the difficulty rating). Those who try to rush their magic are prone to errors and mishaps.</p>
      </div>
      <div class="sheet-step-3">
        <h3>range</h3>
        <div class="sheet-options">
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_range" type="radio" value="personal range,1" checked="checked"/>personal range
            </label><span class="cost">1 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_range" type="radio" value="melee range,2"/>melee range
            </label><span class="cost">2 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_range" type="radio" value="near missile range,3"/>near missile range
            </label><span class="cost">3 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_range" type="radio" value="far missile range,4"/>far missile range
            </label><span class="cost">4 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_range" type="radio" value="artillery range,5"/>artillery range
            </label><span class="cost">5 point(s)</span>
          </div>
        </div>
        <p>Spells required to function at very long ranges carry a much greater chance of failure and demand more effort (spell points). For instance, healing a comrade's wounds becomes much easier if you can lay your hands upon him than if you must heal him from some distance.</p>
      </div>
      <div class="sheet-step-4">
        <h3>duration</h3>
        <div class="sheet-options">
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_duration" type="radio" value="instant,1" checked="checked"/>instant
            </label><span class="cost">1 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_duration" type="radio" value="1 minute,2"/>1 minute
            </label><span class="cost">2 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_duration" type="radio" value="15 minutes,3"/>15 minutes
            </label><span class="cost">3 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_duration" type="radio" value="30 minutes,4"/>30 minutes
            </label><span class="cost">4 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_duration" type="radio" value="1 hour,5"/>1 hour
            </label><span class="cost">5 point(s)</span>
          </div>
        </div>
        <p>The effects of some spells are over almost as soon as they have begun, while others linger for minutes or even an hour after casting. Of course, the longer a caster expects a spell to remain in effect, the more difficult it becomes to cast.</p>
      </div>
      <div class="sheet-step-5">
        <h3>area of effect</h3>
        <div class="sheet-options">
          <label>
            <input name="attr_spell_area_of_effect" type="radio" value="0" checked="checked"/>group area of effect
          </label>
          <label>
            <input name="attr_spell_area_of_effect" type="radio" value="1"/>place area of effect
          </label>
          <label> 
            <input name="attr_spell_area_of_effect" type="radio" value="2"/>temporal area of effect
          </label>
        </div>
        <p>The fourth aspect of a spell's design concerns the amount of area its effects cover. Spells designed to affect a single individual prove much easier to cast than those intended to destroy dozens.</p>
      </div>
      <div class="sheet-step-6 sheet-0">
        <h3>group areas of effect</h3>
        <div class="sheet-options">
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_group_areas_of_effect" type="radio" value="individual,1" checked="checked"/>individual
            </label><span class="cost">1 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_group_areas_of_effect" type="radio" value="couple,2"/>couple
            </label><span class="cost">2 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_group_areas_of_effect" type="radio" value="small group (5 people),3"/>small group (5 people)
            </label><span class="cost">3 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_group_areas_of_effect" type="radio" value="large group (10 people),4"/>large group (10 people)
            </label><span class="cost">4 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_group_areas_of_effect" type="radio" value="crowd (25 people),5"/>crowd (25 people)
            </label><span class="cost">5 point(s)</span>
          </div>
        </div>
        <p>The chart on the next page is appropriate for spells that affect people, from an individual to a group. The targets must remain more or less together, however, not scattered across an open field.</p>
      </div>
      <div class="sheet-step-6 sheet-1">
        <h3>place areas of effect</h3>
        <div class="sheet-options">
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_place_areas_of_effect" type="radio" value="individual,1" checked="checked"/>individual
            </label><span class="cost">1 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_place_areas_of_effect" type="radio" value="small room,2"/>small room
            </label><span class="cost">2 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_place_areas_of_effect" type="radio" value="large room,3"/>large room
            </label><span class="cost">3 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_place_areas_of_effect" type="radio" value="small house,4"/>small house
            </label><span class="cost">4 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_place_areas_of_effect" type="radio" value="large house,5"/>large house
            </label><span class="cost">5 point(s)</span>
          </div>
        </div>
        <p>If the caster can better define a spell's area of effect in terms of spatial size, the player should consult the following chart to determine this property's difficulty rating.</p>
      </div>
      <div class="sheet-step-6 sheet-2">
        <h3>temporal areas of effect</h3>
        <div class="sheet-options">
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_temporal_areas_of_effect" type="radio" value="1 minute,1" checked="checked"/>1 minute
            </label><span class="cost">1 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_temporal_areas_of_effect" type="radio" value="1 hour,2"/>1 hour
            </label><span class="cost">2 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_temporal_areas_of_effect" type="radio" value="1 day,3"/>1 day
            </label><span class="cost">3 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_temporal_areas_of_effect" type="radio" value="1 week,4"/>1 week
            </label><span class="cost">4 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_temporal_areas_of_effect" type="radio" value="1 month,5"/>1 month
            </label><span class="cost">5 point(s)</span>
          </div>
        </div>
        <p>Divination spells sometimes look into the future or past in their quest for information. In such cases, the number of hours (or weeks) a sorcerer has to reach backward or forward for the view dictates the spell's area of effect.</p>
      </div>
      <div class="sheet-step-7">
        <h3>effect</h3>
        <div class="options">
          <label>
            <input name="attr_spell_effect" type="radio" value="0" checked="checked"/>numeric adjustments
          </label>
          <label>
            <input name="attr_spell_effect" type="radio" value="1"/>healing spells
          </label>
          <label>
            <input name="attr_spell_effect" type="radio" value="2"/>other spell effects
          </label>
        </div>
        <p>The most difficult aspect of a spell to quantify is its effect. Nevertheless, the following tables provide appropriate difficulty ratings for various spell types.</p>
      </div>
      <div class="sheet-step-8 sheet-0">
        <h3>numeric adjustments</h3>
        <div class="sheet-options">
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_numeric_adjustments" type="radio" value="+/- 1 to 2 points,1" checked="checked"/>+/- 1 to 2 points
            </label><span class="cost">1 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_numeric_adjustments" type="radio" value="+/- 3 to 5 points,2"/>+/- 3 to 5 points
            </label><span class="cost">2 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_numeric_adjustments" type="radio" value="+/- 6 to 9 points,3"/>+/- 6 to 9 points
            </label><span class="cost">3 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_numeric_adjustments" type="radio" value="+/- 10 to 14 points,4"/>+/- 10 to 14 points
            </label><span class="cost">4 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_numeric_adjustments" type="radio" value="+/- 15 to 20 points,5"/>+/- 15 to 20 points
            </label><span class="cost">5 point(s)</span>
          </div>
        </div>
        <p>When a caster intends a spell to cause damage or offer defense against an attack, a player can rate the casting difficulty of its effects fairly easily. Whenever</p>
      </div>
      <div class="sheet-step-8 sheet-1">
        <h3>healing spells</h3>
        <div class="sheet-options">
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_healing_spells" type="radio" value="1 card/point,1" checked="checked"/>1 card/point
            </label><span class="cost">1 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_healing_spells" type="radio" value="2 cards/point,2"/>2 cards/point
            </label><span class="cost">2 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_healing_spells" type="radio" value="3 cards/point,3"/>3 cards/point
            </label><span class="cost">3 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_healing_spells" type="radio" value="4 cards/point,4"/>4 cards/point
            </label><span class="cost">4 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_healing_spells" type="radio" value="5 cards/point,5"/>5 cards/point
            </label><span class="cost">5 point(s)</span>
          </div>
        </div>
        <p>One of the most valuable aspects of mystic magic is its curative ability. In game terms, this effect takes the form of returning lost cards to a hero's hand (or lost Endurance points to a character).</p>
      </div>
      <div class="sheet-step-8 sheet-2">
        <h3>other spell effects</h3>
        <div class="sheet-options">
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_other_spell_effects" type="radio" value="Irritating,1" checked="checked"/>Irritating
            </label><span class="cost">1 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_other_spell_effects" type="radio" value="Troublesome,2"/>Troublesome
            </label><span class="cost">2 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_other_spell_effects" type="radio" value="Hindering,3"/>Hindering
            </label><span class="cost">3 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_other_spell_effects" type="radio" value="Impeding,4"/>Impeding
            </label><span class="cost">4 point(s)</span>
          </div>
          <div class="sheet-row sheet-attribute-pick">
            <label>
              <input name="attr_spell_other_spell_effects" type="radio" value="Painful,5"/>Painful
            </label><span class="cost">5 point(s)</span>
          </div>
        </div>
        <p>If the spell effect does not seem as easily defined as the above examples, the Narrator assigns it a difficulty rating based on his assessment of the spell's desired outcome.</p>
      </div>
      <div class="sheet-step-9">
        <h3>optional spell description</h3>
        <textarea class="sheet-align-left" name="attr_spell_description"></textarea>
      </div>
    </div>
    <div class="sheet-spell-cost">
      <h3>spell cost: <span name="attr_spell_cost"></span></h3>
    </div>
    <div class="sheet-grid-container sheet-navigation">
      <div class="sheet-grid-col">
        <button type="action" name="act_prev_step">Previous</button>
      </div>
      <div class="sheet-grid-col">
        <button class="sheet-next sheet-primary" type="action" name="act_next_step">Next</button>
        <button class="sheet-save sheet-primary" type="action" name="act_save">Save          </button>
      </div>
    </div>
  </div>
  <button class="sheet-blocker" type="action" name="act_close"></button>
</div>
<div class="sheet-character-sheet sheet-grid-container">
  <div class="sheet-grid-col">
    <div class="sheet-group">
      <h2>personal information</h2>
      <div class="sheet-row sheet-attribute-simple">
        <label for="attr_character_name">Hero</label>
        <input name="attr_character_name" type="text"/>
      </div>
      <div class="sheet-row sheet-attribute-simple">
        <label for="race">race</label>
        <input name="attr_race" type="text"/>
      </div>
      <div class="sheet-row sheet-attribute-simple">
        <label for="role">role</label>
        <input name="attr_role" type="text"/>
      </div>
      <div class="sheet-row sheet-attribute-with-card">
        <input class="sheet-align-left" name="attr_demeanor" type="text" placeholder="demeanor"/>
        <input name="attr_demeanor_card" type="text" placeholder="card"/>
      </div>
      <div class="sheet-row sheet-attribute-with-card">
        <input class="sheet-align-left" name="attr_nature" type="text" placeholder="nature"/>
        <input name="attr_nature_card" type="text" placeholder="card"/>
      </div>
    </div>
    <div class="sheet-group physical-description">
      <h2>physical description</h2>
      <div class="sheet-grid-container">
        <div class="sheet-grid-col">
          <div class="sheet-row sheet-attribute-simple">
            <label for="age">age</label>
            <input name="attr_age" type="text"/>
          </div>
          <div class="sheet-row sheet-attribute-simple">
            <label for="sex">sex</label>
            <input name="attr_sex" type="text"/>
          </div>
          <div class="sheet-row sheet-attribute-simple">
            <label for="hair">hair</label>
            <input name="attr_hair" type="text"/>
          </div>
        </div>
        <div class="sheet-grid-col">
          <div class="sheet-row sheet-attribute-simple">
            <label for="eyes">eyes</label>
            <input name="attr_eyes" type="text"/>
          </div>
          <div class="sheet-row sheet-attribute-simple">
            <label for="height">height</label>
            <input name="attr_height" type="text"/>
          </div>
          <div class="sheet-row sheet-attribute-simple">
            <label for="weight">weight</label>
            <input name="attr_weight" type="text"/>
          </div>
        </div>
      </div>
      <textarea class="sheet-distinguishing-features" name="attr_distinguishing_features" placeholder="Distinguishing Features" rows="5"></textarea>
    </div>
    <div class="sheet-group background">
      <h2>background</h2>
      <div class="sheet-row sheet-attribute-simple">
        <label for="homeland">homeland</label>
        <input name="attr_homeland" type="text"/>
      </div>
      <div class="sheet-row sheet-attribute-simple">
        <label for="social status">social status</label>
        <input name="attr_social_status" type="text"/>
      </div>
      <div class="sheet-row sheet-attribute-simple">
        <label for="reputation">reputation</label>
        <input name="attr_reputation" type="text"/>
      </div>
      <div class="sheet-grid-container sheet-small">
        <div class="sheet-grid-col">
          <div class="sheet-row sheet-attribute-simple">
            <label for="hand">hand</label>
            <input name="attr_hand" type="text"/>
          </div>
        </div>
        <div class="sheet-grid-col">
          <div class="sheet-row sheet-attribute-simple">
            <label for="wealth">wealth</label>
            <input name="attr_wealth" type="text"/>
          </div>
        </div>
        <div class="sheet-grid-col">
          <div class="sheet-row sheet-attribute-simple">
            <label for="quests">quests</label>
            <input name="attr_quests" type="text"/>
          </div>
        </div>
      </div>
    </div>
    <div class="sheet-group">
      <h2>special abilities/limitations</h2>
      <textarea class="sheet-special-abilities-and-limitations" name="attr_special_abilities_and_limitations" rows="5"></textarea>
    </div>
    <div class="sheet-group">
      <h2>treasures</h2>
      <textarea class="sheet-treasures" name="attr_treasures" rows="10"></textarea>
    </div>
  </div>
  <div class="sheet-grid-col">
    <div class="sheet-group sheet-abilities">
      <h2>ability scores</h2>
      <div class="sheet-grid-container">
        <div class="sheet-grid-col">
          <h3>coordination</h3>
          <div class="sheet-grid-container sheet-small">
            <div class="sheet-grid-col">
              <label class="sheet-p-rel" for="agility">agility</label>
              <div class="sheet-p-rel sheet-ability-score sheet-agility">
                <input class="sheet-agility" name="attr_agility" type="number" max="9"/>
              </div>
            </div>
            <div class="sheet-grid-col">
              <div class="sheet-row sheet-ability-code">
                <div class="sheet-flex-container">
                  <input type="radio" name="attr_agility_code" value="A"/>
                  <input type="radio" name="attr_agility_code" value="B"/>
                  <input type="radio" name="attr_agility_code" value="C"/>
                  <input type="radio" name="attr_agility_code" value="D"/>
                  <input type="radio" name="attr_agility_code" value="X"/>
                </div>
              </div>
            </div>
          </div>
          <div class="sheet-grid-container sheet-small">
            <div class="sheet-grid-col">
              <label class="sheet-p-rel" for="dexterity">dexterity</label>
              <div class="sheet-p-rel sheet-ability-score sheet-dexterity">
                <input class="sheet-dexterity" name="attr_dexterity" type="number" max="9"/>
              </div>
            </div>
            <div class="sheet-grid-col">
              <div class="sheet-row sheet-ability-code">
                <div class="sheet-flex-container">
                  <input type="radio" name="attr_dexterity_code" value="A"/>
                  <input type="radio" name="attr_dexterity_code" value="B"/>
                  <input type="radio" name="attr_dexterity_code" value="C"/>
                  <input type="radio" name="attr_dexterity_code" value="D"/>
                  <input type="radio" name="attr_dexterity_code" value="X"/>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="sheet-grid-col">
          <h3>physique</h3>
          <div class="sheet-grid-container sheet-small">
            <div class="sheet-grid-col">
              <label class="sheet-p-rel" for="endurance">endurance</label>
              <div class="sheet-p-rel sheet-ability-score sheet-endurance">
                <input class="sheet-endurance" name="attr_endurance" type="number" max="9"/>
              </div>
            </div>
            <div class="sheet-grid-col">
              <div class="sheet-row sheet-ability-code">
                <div class="sheet-flex-container">
                  <input type="radio" name="attr_endurance_code" value="A"/>
                  <input type="radio" name="attr_endurance_code" value="B"/>
                  <input type="radio" name="attr_endurance_code" value="C"/>
                  <input type="radio" name="attr_endurance_code" value="D"/>
                  <input type="radio" name="attr_endurance_code" value="X"/>
                </div>
              </div>
            </div>
          </div>
          <div class="sheet-grid-container sheet-small">
            <div class="sheet-grid-col">
              <label class="sheet-p-rel" for="strength">strength</label>
              <div class="sheet-p-rel sheet-ability-score sheet-strength">
                <input class="sheet-strength" name="attr_strength" type="number" max="9"/>
              </div>
            </div>
            <div class="sheet-grid-col">
              <div class="sheet-row sheet-ability-code">
                <div class="sheet-flex-container">
                  <input type="radio" name="attr_strength_code" value="A"/>
                  <input type="radio" name="attr_strength_code" value="B"/>
                  <input type="radio" name="attr_strength_code" value="C"/>
                  <input type="radio" name="attr_strength_code" value="D"/>
                  <input type="radio" name="attr_strength_code" value="X"/>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="sheet-grid-col">
          <h3>intellect</h3>
          <div class="sheet-grid-container sheet-small">
            <div class="sheet-grid-col">
              <label class="sheet-p-rel" for="reason">reason</label>
              <div class="sheet-p-rel sheet-ability-score sheet-reason">
                <input class="sheet-reason" name="attr_reason" type="number" max="9"/>
              </div>
            </div>
            <div class="sheet-grid-col">
              <div class="sheet-row sheet-ability-code">
                <div class="sheet-flex-container">
                  <input type="radio" name="attr_reason_code" value="A"/>
                  <input type="radio" name="attr_reason_code" value="B"/>
                  <input type="radio" name="attr_reason_code" value="C"/>
                  <input type="radio" name="attr_reason_code" value="D"/>
                  <input type="radio" name="attr_reason_code" value="X"/>
                </div>
              </div>
            </div>
          </div>
          <div class="sheet-grid-container sheet-small">
            <div class="sheet-grid-col">
              <label class="sheet-p-rel" for="perception">perception</label>
              <div class="sheet-p-rel sheet-ability-score sheet-perception">
                <input class="sheet-perception" name="attr_perception" type="number" max="9"/>
              </div>
            </div>
            <div class="sheet-grid-col">
              <div class="sheet-row sheet-ability-code">
                <div class="sheet-flex-container">
                  <input type="radio" name="attr_perception_code" value="A"/>
                  <input type="radio" name="attr_perception_code" value="B"/>
                  <input type="radio" name="attr_perception_code" value="C"/>
                  <input type="radio" name="attr_perception_code" value="D"/>
                  <input type="radio" name="attr_perception_code" value="X"/>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="sheet-grid-col">
          <h3>essence</h3>
          <div class="sheet-grid-container sheet-small">
            <div class="sheet-grid-col">
              <label class="sheet-p-rel" for="spirit">spirit</label>
              <div class="sheet-p-rel sheet-ability-score sheet-spirit">
                <input class="sheet-spirit" name="attr_spirit" type="number" max="9"/>
              </div>
            </div>
            <div class="sheet-grid-col">
              <div class="sheet-row sheet-ability-code">
                <div class="sheet-flex-container">
                  <input type="radio" name="attr_spirit_code" value="A"/>
                  <input type="radio" name="attr_spirit_code" value="B"/>
                  <input type="radio" name="attr_spirit_code" value="C"/>
                  <input type="radio" name="attr_spirit_code" value="D"/>
                  <input type="radio" name="attr_spirit_code" value="X"/>
                </div>
              </div>
            </div>
          </div>
          <div class="sheet-grid-container sheet-small">
            <div class="sheet-grid-col">
              <label class="sheet-p-rel" for="presence">presence</label>
              <div class="sheet-p-rel sheet-ability-score sheet-presence">
                <input class="sheet-presence" name="attr_presence" type="number" max="9"/>
              </div>
            </div>
            <div class="sheet-grid-col">
              <div class="sheet-row sheet-ability-code">
                <div class="sheet-flex-container">
                  <input type="radio" name="attr_presence_code" value="A"/>
                  <input type="radio" name="attr_presence_code" value="B"/>
                  <input type="radio" name="attr_presence_code" value="C"/>
                  <input type="radio" name="attr_presence_code" value="D"/>
                  <input type="radio" name="attr_presence_code" value="X"/>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="sheet-group">
      <h2>arms &amp; armors</h2>
      <div class="sheet-row sheet-attribute-combat">
        <label for="attr_melee_weapon">melee weapon</label>
        <input name="attr_melee_weapon" type="text"/>
        <input name="attr_melee_weapon_dmg" type="number" placeholder="dmg"/>
      </div>
      <div class="sheet-row sheet-attribute-combat">
        <label for="attr_missile_weapon">missile weapon</label>
        <input name="attr_missile_weapon" type="text"/>
        <input name="attr_missile_weapon_dmg" type="number" placeholder="dmg"/>
      </div>
      <div class="sheet-row sheet-attribute-combat">
        <label for="attr_armor">armor</label>
        <input name="attr_armor" type="text"/>
        <input name="attr_armor_def" type="number" placeholder="def"/>
      </div>
      <div class="sheet-row sheet-attribute-combat">
        <label for="attr_shield">shield</label>
        <input name="attr_shield" type="text"/>
        <input name="attr_shield_def" type="number" placeholder="def"/>
      </div>
    </div>
    <div class="sheet-group">
      <h2>spell casting pool</h2>
      <div class="sheet-grid-container">
        <div class="sheet-grid-col">
          <div class="sheet-row sheet-attribute-simple">
            <label for="sorcery">sorcery<span class="sheet-max" name="attr_sorcery_max"></span></label>
            <input name="attr_sorcery" type="text"/>
            <input name="attr_sorcery_max" type="hidden" value="0"/>
          </div>
        </div>
        <div class="sheet-grid-col">
          <div class="sheet-row sheet-attribute-simple">
            <label for="mysticism">mysticism<span class="sheet-max" name="attr_mysticism_max"></span></label>
            <input name="attr_mysticism" type="text"/>
            <input name="attr_mysticism_max" type="hidden" value="0"/>
          </div>
        </div>
      </div>
      <div class="sheet-spells">
        <fieldset class="repeating_spells">
          <h3>
            <input class="sheet-align-left" type="text" name="attr_spell_name"/>
          </h3>
          <div><strong>Invocation time: </strong><span name="attr_spell_invocation_time"></span></div>
          <div><strong>Range: </strong><span name="attr_spell_range"></span></div>
          <div><strong>Duration: </strong><span name="attr_spell_duration"></span></div>
          <div><strong>Area of effect: </strong><span name="attr_spell_area_of_effect"></span></div>
          <div><strong>Effect: </strong><span name="attr_spell_effect"></span></div>
          <div><strong>Cost: </strong><span name="attr_spell_cost"></span></div>
          <div><strong>Description:</strong>
            <textarea name="attr_spell_description"></textarea><span name="attr_spell_description">        </span>
          </div>
        </fieldset>
      </div>
      <button class="sheet-primary" type="action" name="act_design">Design Spell</button>
    </div>
    <div class="sheet-group">
      <h2>additional information</h2>
      <textarea class="sheet-additional-information" name="attr_additional_information" rows="5"></textarea>
    </div>
  </div>
</div>
<div style="padding: 0 5px;">
  <input type="hidden" name="attr_player_hand" value=""/>
  <input type="hidden" name="attr_player_hand_size" value=""/>
  <input type="hidden" name="attr_graveyard" value=""/>
  <fieldset class="repeating_cards">
    <div class="card">
      <input type="hidden" name="attr_color"/>
      <input type="hidden" name="attr_suit"/>
      <input type="hidden" name="attr_demeanor"/>
      <input type="hidden" name="attr_nature"/>
      <input type="hidden" name="attr_value"/>
      <input type="hidden" name="attr_name"/>
      <button class="discard" type="action" name="act_discard">Discard</button>
      <div class="mask">
        <div class="texture"></div>
      </div>
      <button class="draw" type="action" name="act_draw"></button>
    </div>
  </fieldset>
</div>
<script type="text/worker">
  class SheetUtils {
    static getUID(value) {
        const regexp = /-.{19}(?=_)|-.{19}$/g;
        const valueAsString = String(value);
        const match = valueAsString.match(regexp);
        return (match) ? match.join() : "";
    }
    static toLowerCase(value) {
        if(Array.isArray(value)) {
            const lowerCaseArray = value.map(item => { return item.toLowerCase(); });
            return lowerCaseArray;
        }
        return String(value).toLowerCase();
    }
    static toCapitalCase(value) {
        if(Array.isArray(value)) {
            const capitalCaseArray = value.map(item => { return item[0].toUpperCase() + item.toLowerCase().slice(1); });
            return capitalCaseArray;
        }
        return String(value)[0].toUpperCase() + String(value).toLowerCase().slice(1);
    }
    static getSectionOrder(section, callback) {
        const sectionName = `repeating_${section}`;
        const attributeName = `_reporder_${sectionName}`;
        getAttrs([attributeName], attributes => {
            let values = new Array();
            Object.keys(attributes).some(() => {
                let results = SheetUtils.toLowerCase(attributes[attributeName].replace(/ /g, '').split(','));
                values = values.concat(results);
                return true;
            });
            getSectionIDs(sectionName, ids => {
                const filteredOrder = new Set();
                const order = values.concat(SheetUtils.toLowerCase(ids));
                order.forEach(item => {
                    filteredOrder.add(item);
                });
                callback(Array.from(filteredOrder));
            });
        });
    }
    static deepReadAttribute(attr, callback, defaultValue) {
        if(/^(@{).+}$/.test(String(attr)) === true) { 
            const regExp = /@\{([^@\{\}]+)\}/;
            const reference = regExp.exec(attr)[1];
            var self = this;
            getAttrs([reference], function(v) {
                if(!v[reference]) { 
                    callback(defaultValue);
                } else {
                    self.deepReadAttribute(v[reference], callback, defaultValue);
                }
            });
        }
        else {
            callback(attr); 
        }
    }
}class FateDeck {
    static CARD_RED = 0;
    static CARD_BLACK = 1;
    static CARD_WHITE = 2;
    static CARD_BACKFACE = 3;

    static SUIT_SHIELD = 0
    static SUIT_ARROW = 1;
    static SUIT_HELM = 2;
    static SUIT_SWORD = 3;
    static SUIT_MOON = 4;
    static SUIT_ORB = 5;
    static SUIT_HEART = 6;
    static SUIT_CROWN = 7;
    static SUIT_DRAGON = 8;
    static MIN_HAND_SIZE = 2;
    static MAX_HAND_SIZE = 10;

    static CARD_COLORS = ['White', 'Red', 'Black'];
    static CARD_SUITS = ['Arrow', 'Crown', 'Dragon', 'Heart', 'Helm', 'Moon', 'Orb', 'Shield', 'Sword'];

    constructor(repeatingAttribute = 'repeating_cards', handsizeAttribute = 'hand', handAttribute = 'player_hand', graveyardAttribute = 'graveyard', delimiter = ',') {
        this._repeating = repeatingAttribute;
        this._handsizeAttribute = handsizeAttribute;;
        this._handAttribute = handAttribute;
        this._graveyardAttribute = graveyardAttribute;
        this._currentHandSizeAttribute = 'player_hand_size';
        this._drawButton = `${repeatingAttribute}:draw`;
        this._discardButton = `${repeatingAttribute}:discard`;
        this._delimiter = delimiter;
        this.setupListeners();
    }

    setupListeners() {
        on('sheet:opened', () => {
            this.setupPile();
        });
        on(`clicked:${this._drawButton}`, () => {
            this.drawCard();
        });
        on(`clicked:${this._discardButton}`, eventInfo => {
            const uid = SheetUtils.getUID(eventInfo.sourceAttribute);
            this.discardCard(uid);
        });
    }

    setupPile(callback) {
        this.getCardsDrawn(drawn => {
            if(drawn.hand.length > 0) return;

            const fateDeck = {
                "color": FateDeck.CARD_BACKFACE,
                "suit": FateDeck.SUIT_SHIELD,
                "name": "fate deck",
                "value": 10,
                "demeanor": "fate",
                "nature": "deck"
            };
            let update = {};
            const uid = generateRowID();
            Object.keys(fateDeck).forEach(property => {
                update[`${this._repeating}_${uid}_${property}`] = fateDeck[property];
            });
            update[this._handAttribute] = fateDeck.name;
            update[this._currentHandSizeAttribute] = 1;
            setAttrs(update, () => {
                if(callback) callback(update);
            });
        });
    }

    getCardsDrawn(callback, extraAttributes = []) {
        getAttrs([this._handsizeAttribute, this._handAttribute, this._graveyardAttribute].concat(extraAttributes), values => {
            const cardsInPlay = {
                handSize: (values[this._handsizeAttribute]) ? parseInt(values[this._handsizeAttribute]) + 1 : FateDeck.MIN_HAND_SIZE,
                hand: (values[this._handAttribute]) ? values[this._handAttribute].split(this._delimiter) : [], 
                graveyard: (values[this._graveyardAttribute]) ? values[this._graveyardAttribute].split(this._delimiter) : []
            };
            if(extraAttributes.length > 0) {
                delete values[this._handsizeAttribute];
                delete values[this._handAttribute];
                delete values[this._graveyardAttribute];
                cardsInPlay.extras = values;
            }
            if(callback) callback(cardsInPlay);
        });
    }

    getDeckStatus(callback) {
        const allCards = [
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_ARROW,
                "name": "tass",
                "value": 1,
                "demeanor": "careless",
                "nature": "innovative"
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_ARROW,
                "name": "tanis",
                "value": 2,
                "demeanor": "meticulous",
                "nature": "resourceful"
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_ARROW,
                "name": "theros",
                "value": 3,
                "demeanor": "scrupulous",
                "nature": "artistic"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_ARROW,
                "name": "blister",
                "value": 4,
                "demeanor": "cautious",
                "nature": "inventive"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_ARROW,
                "name": "kith-kanan",
                "value": 5,
                "demeanor": "conscientious",
                "nature": "clever"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_ARROW,
                "name": "porthios",
                "value": 6,
                "demeanor": "distant",
                "nature": "cunning"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_ARROW,
                "name": "otik",
                "value": 7,
                "demeanor": "fastidious",
                "nature": "conventional"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_ARROW,
                "name": "gildentongue",
                "value": 8,
                "demeanor": "careful",
                "nature": "unimaginative"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_ARROW,
                "name": "bakaris",
                "value": 9,
                "demeanor": "heedless",
                "nature": "dogmatic"
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_CROWN,
                "name": "gunthar",
                "value": 1,
                "demeanor": "authoritative",
                "nature": "just"
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_CROWN,
                "name": "laurana",
                "value": 2,
                "demeanor": "inspiring",
                "nature": "fair"
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_CROWN,
                "name": "moonsong",
                "value": 3,
                "demeanor": "independent",
                "nature": "reasonable"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_CROWN,
                "name": "severus",
                "value": 4,
                "demeanor": "charismatic",
                "nature": "demanding"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_CROWN,
                "name": "belladonna",
                "value": 5,
                "demeanor": "lawless",
                "nature": "tough"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_CROWN,
                "name": "mirielle",
                "value": 6,
                "demeanor": "imperious",
                "nature": "commanding"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_CROWN,
                "name": "seeker hederick",
                "value": 7,
                "demeanor": "egotistical",
                "nature": "despotic"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_CROWN,
                "name": "fewmaster toede",
                "value": 8,
                "demeanor": "inspiring",
                "nature": "tyranical"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_CROWN,
                "name": "verminaard",
                "value": 9,
                "demeanor": "domineering",
                "nature": "dictatorial"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_DRAGON,
                "name": "solomirathnius",
                "value": 1,
                "demeanor": "eccentric",
                "nature": ""
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_DRAGON,
                "name": "suhnrysanti",
                "value": 2,
                "demeanor": "hedonistic",
                "nature": ""
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_DRAGON,
                "name": "shatraklangg",
                "value": 3,
                "demeanor": "cantankerous",
                "nature": ""
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_DRAGON,
                "name": "teranyex",
                "value": 4,
                "demeanor": "egomaniacal",
                "nature": ""
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_DRAGON,
                "name": "iyesta",
                "value": 5,
                "demeanor": "vain",
                "nature": ""
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_DRAGON,
                "name": "onysablet",
                "value": 6,
                "demeanor": "treacherous",
                "nature": ""
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_DRAGON,
                "name": "khellendros",
                "value": 7,
                "demeanor": "wrathful",
                "nature": ""
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_DRAGON,
                "name": "beryllinthranox",
                "value": 8,
                "demeanor": "malicious",
                "nature": ""
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_DRAGON,
                "name": "gellidus",
                "value": 9,
                "demeanor": "sadistic",
                "nature": ""
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_DRAGON,
                "name": "malystryx",
                "value": 10,
                "demeanor": "megalomaniac",
                "nature": ""
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_HEART,
                "name": "crysania",
                "value": 1,
                "demeanor": "calm",
                "nature": "merciful"
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_HEART,
                "name": "jasper",
                "value": 2,
                "demeanor": "honest",
                "nature": "kind"
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_HEART,
                "name": "goldmoon",
                "value": 3,
                "demeanor": "sensible",
                "nature": "compassionate"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_HEART,
                "name": "vinas",
                "value": 4,
                "demeanor": "honorable",
                "nature": "grandiose"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_HEART,
                "name": "lorac",
                "value": 5,
                "demeanor": "realistic",
                "nature": "self-centered"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_HEART,
                "name": "gargath",
                "value": 6,
                "demeanor": "deceitful",
                "nature": "uncaring"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_HEART,
                "name": "lord soth",
                "value": 7,
                "demeanor": "pragmatic",
                "nature": "murderous"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_HEART,
                "name": "ariakan",
                "value": 8,
                "demeanor": "forthright",
                "nature": "cruel"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_HEART,
                "name": "kingpriest",
                "value": 9,
                "demeanor": "dishonest",
                "nature": "immoral"
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_HELM,
                "name": "caramon",
                "value": 1,
                "demeanor": "thorough",
                "nature": "brave"
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_HELM,
                "name": "flint",
                "value": 2,
                "demeanor": "resolute",
                "nature": "stouthearted"
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_HELM,
                "name": "kharas",
                "value": 3,
                "demeanor": "decisive",
                "nature": "corageous"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_HELM,
                "name": "derkin",
                "value": 4,
                "demeanor": "cautious",
                "nature": "resolute"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_HELM,
                "name": "dougan",
                "value": 5,
                "demeanor": "purposeful",
                "nature": "careful"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_HELM,
                "name": "silver claw",
                "value": 6,
                "demeanor": "determined",
                "nature": "cicumspect"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_HELM,
                "name": "rennard",
                "value": 7,
                "demeanor": "decisive",
                "nature": "cowaraly"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_HELM,
                "name": "bertrem",
                "value": 8,
                "demeanor": "dedicated",
                "nature": "timid"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_HELM,
                "name": "bupu",
                "value": 9,
                "demeanor": "groveling",
                "nature": "afraid"
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_MOON,
                "name": "palin",
                "value": 1,
                "demeanor": "impulsive",
                "nature": "inquisitive"
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_MOON,
                "name": "par-salian",
                "value": 2,
                "demeanor": "thoughful",
                "nature": "curious"
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_MOON,
                "name": "fizban",
                "value": 3,
                "demeanor": "absent-minded",
                "nature": "nosy"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_MOON,
                "name": "justarius",
                "value": 4,
                "demeanor": "thoughful",
                "nature": "contemplative"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_MOON,
                "name": "shadow sorcerer",
                "value": 5,
                "demeanor": "enigmatic",
                "nature": "introspective"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_MOON,
                "name": "magius",
                "value": 6,
                "demeanor": "rash",
                "nature": "crafty"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_MOON,
                "name": "fistandantilus",
                "value": 7,
                "demeanor": "mysterious",
                "nature": "plotting"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_MOON,
                "name": "dalamar",
                "value": 8,
                "demeanor": "thoughful",
                "nature": "conniving"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_MOON,
                "name": "raistlin",
                "value": 9,
                "demeanor": "obsessive",
                "nature": "scheming"
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_ORB,
                "name": "alhana",
                "value": 1,
                "demeanor": "reserved",
                "nature": "insightful"
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_ORB,
                "name": "gilthas",
                "value": 2,
                "demeanor": "serious",
                "nature": "open-minded"
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_ORB,
                "name": "sara",
                "value": 3,
                "demeanor": "toughful",
                "nature": "insightful"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_ORB,
                "name": "astinus",
                "value": 4,
                "demeanor": "studious",
                "nature": "methodcal"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_ORB,
                "name": "riverwind",
                "value": 5,
                "demeanor": "deliberate",
                "nature": "vigilant"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_ORB,
                "name": "groller",
                "value": 6,
                "demeanor": "simple",
                "nature": "observant"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_ORB,
                "name": "ackal",
                "value": 7,
                "demeanor": "shrewd",
                "nature": "bigoted"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_ORB,
                "name": "verash",
                "value": 8,
                "demeanor": "studious",
                "nature": "opinionated"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_ORB,
                "name": "highbulp phudge",
                "value": 9,
                "demeanor": "lazy",
                "nature": "prejudiced"
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_SHIELD,
                "name": "tika",
                "value": 1,
                "demeanor": "nosy",
                "nature": "opinionated"
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_SHIELD,
                "name": "usha",
                "value": 2,
                "demeanor": "gregarious",
                "nature": "optimistic"
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_SHIELD,
                "name": "linsha",
                "value": 3,
                "demeanor": "tight-lipped",
                "nature": "confident"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_SHIELD,
                "name": "gilthanas",
                "value": 4,
                "demeanor": "capable",
                "nature": "stubborn"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_SHIELD,
                "name": "maquesta",
                "value": 5,
                "demeanor": "open",
                "nature": "sensible"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_SHIELD,
                "name": "milgas",
                "value": 6,
                "demeanor": "modest",
                "nature": "practical"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_SHIELD,
                "name": "ferilleeagh",
                "value": 7,
                "demeanor": "wild",
                "nature": "realistic"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_SHIELD,
                "name": "rig mer-krel",
                "value": 8,
                "demeanor": "roguish",
                "nature": "cynical"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_SHIELD,
                "name": "jendaron",
                "value": 9,
                "demeanor": "prying",
                "nature": "pessimistic"
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_SWORD,
                "name": "sturm",
                "value": 1,
                "demeanor": "courageous",
                "nature": "inspiring"
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_SWORD,
                "name": "sir liam",
                "value": 2,
                "demeanor": "brave",
                "nature": "commanding"
            },
            {
                "color": FateDeck.CARD_WHITE,
                "suit": FateDeck.SUIT_SWORD,
                "name": "huma",
                "value": 3,
                "demeanor": "valiant",
                "nature": "motivated"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_SWORD,
                "name": "steel",
                "value": 4,
                "demeanor": "aggressive",
                "nature": "commanding"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_SWORD,
                "name": "dhamon",
                "value": 5,
                "demeanor": "relentless",
                "nature": "independent"
            },
            {
                "color": FateDeck.CARD_RED,
                "suit": FateDeck.SUIT_SWORD,
                "name": "kaz",
                "value": 6,
                "demeanor": "domineering",
                "nature": "belligerent"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_SWORD,
                "name": "chot",
                "value": 7,
                "demeanor": "aggressive",
                "nature": "brutal"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_SWORD,
                "name": "kitiara",
                "value": 8,
                "demeanor": "commanding",
                "nature": "fierce"
            },
            {
                "color": FateDeck.CARD_BLACK,
                "suit": FateDeck.SUIT_SWORD,
                "name": "emperor ariakas",
                "value": 9,
                "demeanor": "ruthless",
                "nature": "sadistic"
            }
        ];
        
        this.getCardsDrawn(drawn => {
            const cardsLeft = allCards.filter(card => { return drawn.hand.indexOf(card.name) === -1 && drawn.graveyard.indexOf(card.name) === -1 });
            if(callback) callback({ pile: cardsLeft, hand: drawn.hand, graveyard: drawn.graveyard, handSize: drawn.handSize });
        });
    }

    drawCard(callback) {
        this.getDeckStatus(status => {
            if(status.hand.length >= status.handSize || status.hand.length >= FateDeck.MAX_HAND_SIZE) {
                if(callback) callback();
                return;
            }
            const randomCard = status.pile[Math.round(Math.random() * (status.pile.length-1))];
            const uid = generateRowID();
            let update = {};
            Object.keys(randomCard).forEach(property => {
                update[`${this._repeating}_${uid}_${property}`] = randomCard[property];
            });
            this.getCardsDrawn(drawn => {
                let hand = new Set(drawn.hand);
                hand.add(randomCard.name);
                update[this._handAttribute] = Array.from(hand).join(this._delimiter);
                update[this._currentHandSizeAttribute] = hand.size;
                setAttrs(update, () => {
                    if(callback) callback(update);
                });
            });
        });
    }

    discardCard(uid) {
        const row = `${this._repeating}_${uid}`;
        const cardNameAttribute = `${row}_name`;
        this.getCardsDrawn(status => {
            let update = {};
            const cardsLeft = status.hand.filter(card => { return card !== status.extras[cardNameAttribute] });
            status.graveyard.push(status.extras[cardNameAttribute]);
            update[this._handAttribute] = cardsLeft.join(this._delimiter);
            update[this._graveyardAttribute] = status.graveyard.join(this._delimiter);
            update[this._currentHandSizeAttribute] = cardsLeft.length;
            setAttrs(update, () => {
                removeRepeatingRow(row);
            });
        },
        [cardNameAttribute]
        );
    }
}const spellAttributes = {
    meta: ['spell_name', 'spell_cost', 'spell_description'],
    global: ['spell_invocation_time', 'spell_range', 'spell_duration'],
    local: ['spell_area_of_effect', 'spell_effect'],
    lookup: {
        'spell_area_of_effect': ['spell_group_areas_of_effect', 'spell_place_areas_of_effect', 'spell_temporal_areas_of_effect'],
        'spell_effect': ['spell_numeric_adjustments', 'spell_healing_spells', 'spell_other_spell_effects']
    },
    all: function() {
        return this.meta.concat(this.global, this.local, this.lookup['spell_area_of_effect'], this.lookup['spell_effect']);
    }
}

const saveSpell = function() {
    const rowUID = generateRowID();
    let newSpell = {};
    getAttrs(spellAttributes.all(), attributes => {
        newSpell[`repeating_spells_${rowUID}_spell_name`] = attributes['spell_name'];
        newSpell[`repeating_spells_${rowUID}_spell_cost`] = attributes['spell_cost'];
        newSpell[`repeating_spells_${rowUID}_spell_description`] = attributes['spell_description'];
        spellAttributes.global.forEach(option => {
            newSpell[`repeating_spells_${rowUID}_${option}`] = getSpellOptionValue(attributes[option], 0);
        });
        spellAttributes.local.forEach(option => {
            const selectedOption = getSpellOptionValue(attributes[option]);
            const selectedOptionLabel = getSpellOptionValue(attributes[spellAttributes.lookup[option][selectedOption]], 0);
            newSpell[`repeating_spells_${rowUID}_${option}`] = selectedOptionLabel;
        });
        setAttrs(newSpell, () => {
            resetSpellDesigner(0);
        });
    });
}

const getSpellCost = function(callback) {
    let spellCost = 0;
    getAttrs(spellAttributes.global.concat(spellAttributes.local, spellAttributes.lookup['spell_area_of_effect'], spellAttributes.lookup['spell_effect']), attributes => {
        spellAttributes.global.forEach(option => {
            spellCost += getSpellOptionValue(attributes[option]);
        });
        spellAttributes.local.forEach(option => {
            const selectedOption = getSpellOptionValue(attributes[option]);
            const selectedOptionCost = getSpellOptionValue(attributes[spellAttributes.lookup[option][selectedOption]]);
            spellCost += selectedOptionCost;
        });
        callback(spellCost);
    });
}

const getSpellOptionValue = function(attribute, returnCost=1) {
    if(!attribute) return 0;
    let value = (attribute.indexOf(',') > -1) ? attribute.split(',')[returnCost] : attribute;
    return (returnCost === 1) ? parseInt(value) : value;
}

const gotoStep = function(step = 1) {
    getAttrs(['spell_step'], values => {
        const currentStep = values['spell_step'];
        const nextStep = Math.min(Math.max(parseInt(currentStep)+step, 1), 20);
        getSpellCost(cost => {
            setAttrs({'spell_cost': cost }, () => {
                setAttrs({'spell_step': nextStep, 'designing_spell_lock': 1 }, () => {
                    console.log('Navigated to step ' + nextStep);
                });
            });
        });
    });
}

const resetSpellDesigner = function(designingSpell = 1) {
    let reset = {
        'designing_spell': designingSpell,
        'spell_cost': 0,
        'spell_step': 1
    }
    spellAttributes.all().forEach(attribute => {
        reset[attribute] = "";
    });
    setAttrs(reset, function() {
        console.log('Reseted Spell Designer');
    });
}

const changeSpellAttributes = spellAttributes.all().map(function(attribute){ return "change:"+attribute; }).join(' ');
on(changeSpellAttributes, eventInfo => {
    getSpellCost(cost => {
        setAttrs({'spell_cost': cost });
    });
});



on('clicked:save', ()=> {
    saveSpell();
});

on('clicked:close', ()=> {
    resetSpellDesigner(0);
});

on('clicked:design', ()=> {
    resetSpellDesigner();
});

on('clicked:prev_step', ()=> {
    gotoStep(-1);
});

on('clicked:next_step', ()=> {
    gotoStep();
});

on('change:reason change:spirit', eventInfo => {
    getAttrs(['reason', 'spirit'], attributes => {
        const sorceryMax = (attributes['reason']) ? Math.pow(parseInt(attributes['reason']), 2) : 0;
        const mysticismMax = (attributes['spirit']) ? Math.pow(parseInt(attributes['spirit']), 2) : 0;
        setAttrs({'sorcery_max':sorceryMax, 'mysticism_max':mysticismMax});
    });
});

const fateDeck = new FateDeck();

//# sourceURL=DL5THAGE.js
</script>